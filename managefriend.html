<html>
<head>
 <meta charset="utf-8" />
    <meta content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no" name="viewport">
    <!-- css -->
    <link href="css/bootstrap.min.css" rel="stylesheet" media="screen">
    <link href="css/style.css" rel="stylesheet" media="screen">
	<link href="color/default.css" rel="stylesheet" media="screen">
	<script src="js/modernizr.custom.js"></script>

  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <link rel="stylesheet" href="http://maxcdn.bootstrapcdn.com/bootstrap/3.3.5/css/bootstrap.min.css">
  <script src="https://ajax.googleapis.com/ajax/libs/jquery/1.11.3/jquery.min.js"></script>
  <script src="http://maxcdn.bootstrapcdn.com/bootstrap/3.3.5/js/bootstrap.min.js"></script>
<style type="text/css">
	*{}
	body{background-color: #1A1A1A;color:white; }
	#manage-friends{
		margin-top: 10px;
		
		font-size: 18px;
	}

	tr:nth-child(even) {background: #CCC;}
	tr:nth-child(odd) {background: #AAA;}
	
	td {padding:1.5px;}
	
	tbody th {text-align:left;}
	th:nth-child(1){padding:1.5px; width:400px;} 
	
</style>
<script src="jquery-2.1.4.min.js"></script>
<script>
var total;
var	table_0 = document.createElement('table');
var table_1 = document.createElement('table');
var table_2 = document.createElement('table');
var friendInfo;

request=$.ajax({
			url:"http://localhost:3000/manageFriend",
			type:"post",
			data:{request: 0, session:localStorage.getItem("session")}
		});
		request.done(function(response,textstatus,jqXHR)
		{
			//console.log(response);
			populate_request0(response);
		})
		request.fail(function (jqXHR, textStatus, errorThrown)
		{
			console.error("The following error occurred: "+textStatus, errorThrown);
		});
				
request=$.ajax({
			url:"http://localhost:3000/manageFriend",
			type:"post",
			data:{request: 2, session:localStorage.getItem("session")}
		});
		request.done(function(response,textstatus,jqXHR)
		{
			//console.log(response);
			populate_request2(response);
		})
		request.fail(function (jqXHR, textStatus, errorThrown)
		{
			console.error("The following error occurred: "+textStatus, errorThrown);
		});
				
request=$.ajax({
			url:"http://localhost:3000/manageFriend",
			type:"post",
			data:{request: 1, session:localStorage.getItem("session")}
		});
		request.done(function(response,textstatus,jqXHR)
		{
			//console.log(response);
			populate_request1(response);
		})
		request.fail(function (jqXHR, textStatus, errorThrown)
		{
			console.error("The following error occurred: "+textStatus, errorThrown);
		});				
				
function loadFriend(val, name, pict) {
//var val = this.id;
//var name = this;

console.log("id " + val);
request=$.ajax({
			url:"http://localhost:3000/getData",
			type:"post",
			async: true,
			data:{session:val}
		});
		request.done(function(response,textstatus,jqXHR)
		{
			resp = response;
			friendInfo = JSON.parse(resp);
			
	//		document.getElementById(name).innerHTML = friendInfo.FName + "," + friendInfo.LName;
			name.innerHTML = friendInfo.FName + ", " + friendInfo.LName;
			
			if(friendInfo.Photo == null)
				pict.src="file:///C:/Users/Xiao/WebstormProjects/backend/default_user.jpg";
			else 
				pict.src="file:///C:/Users/Xiao/WebstormProjects/backend/" + friendInfo.Email + friendInfo.Photo;

			console.log(friendInfo.FName + friendInfo.LName + friendInfo.Photo);
		})
		request.fail(function (jqXHR, textStatus, errorThrown)
		{
			console.error("The following error occurred: "+textStatus, errorThrown);
		});
}
				
function populate_request0(val)
{

	var data=JSON.parse(val);
	total = data.length;
	
	if(total > 0) 
	{
		for(var i = 0; i < data.length; i++) 
		{
			//console.log(data[i].YourEmail);		

			//table_0.setAttribute("align", "center");
	
			tr = document.createElement('tr');   
		
			for(var k=0; k<2; k++) 
			{
				td1 = document.createElement('td');
			//var input = document.createElement('input');
				if(k===0)
				{
					var userfriend = document.createElement('label');
					var userimg = document.createElement('img');
					
					userfriend.onload = loadFriend(data[i].YourEmail, userfriend, userimg);				
					
					userimg.setAttribute("width", "50px");
					userimg.setAttribute("height", "50px");
					
					td1.appendChild(userimg);
					td1.appendChild(userfriend);				
				}
				else
				{
					var but = document.createElement('button');
					but.innerHTML="VIEW";
					but.onclick=viewFriend;
					but.id=data[i].YourEmail;
					but.className = "btn btn-primary";
					td1.appendChild(but);
				}	
		
				tr.appendChild(td1);
			}
			
			table_0.appendChild(tr); 
		} 
	}
	else
	{
		tr = document.createElement('tr');   
		td1 = document.createElement('a');
		td1.setAttribute("href", "friend.html");
		td1.innerHTML	= "Make more friends!";
		tr.appendChild(td1);
		table_0.appendChild(tr);
	}
}
	

function populate_request2(val)
{
	var data=JSON.parse(val);
	total = data.length;
		
	//table_2.setAttribute("align", "center");
	
	if(total > 0) 
	{	
		for( var i = 0;i < total;i++)
		{
			tr = document.createElement('tr');   
			
			for(var j = 0; j < 2; j++)
			{
				td1 = document.createElement('td');
			
				if(j===0) 
				{
					var userfriend = document.createElement('label');
					var userimg = document.createElement('img');
					
					userfriend.onload = loadFriend(data[i].YourEmail, userfriend, userimg);
					
					userimg.setAttribute("width", "50px");
					userimg.setAttribute("height", "50px");
					td1.appendChild(userimg);					
					td1.appendChild(userfriend);
				}
				
				else 
				{
					var but = document.createElement('button');
					but.innerHTML="VIEW";
					but.onclick=viewFriend;
					but.id=data[i].YourEmail;
					but.className = "btn btn-primary";
					td1.appendChild(but);
				}
				tr.appendChild(td1);
			}
			table_2.appendChild(tr);
		} 
	}
	else 
	{
		tr = document.createElement('tr');   
		td1 = document.createElement('a');
		td1.setAttribute("href", "friend.html");
		//var input = document.createElement('input');
		td1.innerHTML = "You don't have any friend yet. Add some!";
		tr.appendChild(td1);
		table_2.appendChild(tr);
	}
}

function populate_request1(val)
{
	var data=JSON.parse(val);
	total = data.length;
	
//	table_1.setAttribute("align", "center");
	
	if(total>0) 
	{
		for( var i = 0;i < total;i++)
		{
			tr = document.createElement('tr');   

			for (var j = 0; j < 4; j++)
			{
				td1 = document.createElement('td');
				if(j===0)
				{
					var userfriend = document.createElement('label');
					var userimg = document.createElement('img');
					
					userfriend.onload = loadFriend(data[i].YourEmail, userfriend, userimg);
					userimg.setAttribute("width", "50px");
					userimg.setAttribute("height", "50px");
					td1.appendChild(userimg);
					td1.appendChild(userfriend);
				}
				
				if(j===1) 
				{
					var bt = document.createElement('button');
					bt.innerHTML="VIEW";
					bt.onclick=viewFriend;
					bt.id=data[i].YourEmail;
					bt.className = "btn btn-primary";
					td1.appendChild(bt);
				}
				
				if(j===2)				
				{
					var but = document.createElement('button');
					but.innerHTML="Accept";
					but.id=data[i].YourEmail;
					but.onclick = approveRequest;
					//alert(i);
					td1.appendChild(but);
					but.className = "btn btn-primary";
				}
				
				if(j===3)
				{
					var butt = document.createElement('button');
					butt.innerHTML="Ignore";
					butt.id=data[i].YourEmail;
					butt.onclick = rejectRequest;
					//alert(i);
					td1.appendChild(butt);
					butt.className = "btn btn-primary";
				}
	//td1.appendChild(input);
			tr.appendChild(td1);
			table_1.appendChild(tr);
			}
		}
	}
	else 
	{
		tr = document.createElement('tr');   
		td1 = document.createElement('td');
		//var input = document.createElement('input');
		td1.innerHTML = "No new friend request.";
		//alert(array[i] + "inside dynamic");
		//td1.appendChild(input);
		tr.appendChild(td1);
		table_1.appendChild(tr);
	}
}

function approveRequest() {
	var val = this.id;
	btn = this;
	request=$.ajax({
				url:"http://localhost:3000/approveRequest",
				type:"post",
				data:{friendEmail:val, session:localStorage.getItem("session")}
			});
	request.done(function(response,textstatus,jqXHR)
	{
			console.log(response);
			btn.disabled = "true";
			btn.innerHTML = "Accepted";
	})
	request.fail(function (jqXHR, textStatus, errorThrown)
	{
			console.error("The following error occurred: "+textStatus, errorThrown);
	});
}

function rejectRequest() {
	var val = this.id;
	btn = this;
	request=$.ajax({
				url:"http://localhost:3000/remove",
				type:"post",
				data:{friendEmail:val, session:localStorage.getItem("session")}
			});
	request.done(function(response,textstatus,jqXHR)
	{
			console.log(response);
			btn.disabled = "true";
			btn.innerHTML = "Ignored";
	})
	request.fail(function (jqXHR, textStatus, errorThrown)
	{
			console.error("The following error occurred: "+textStatus, errorThrown);
	});
}

function viewFriend() 
	{
		var frienduser;
		frienduser = this.id;
		window.location.href="view.html";
		localStorage.setItem("sessionfriend", frienduser);
	}
	
function populateTables() 
{
		document.getElementById("divtab0").appendChild(table_0);
		document.getElementById("divtab1").appendChild(table_1);
		document.getElementById("divtab2").appendChild(table_2);
}	

function logout()
    {
        //alert("Hello");
        localStorage.removeItem("session");
        window.location.href="index.html";
        
    }
</script>

</head>
<body onload="populateTables()">
<div class="menu-area">
			<div id="dl-menu" class="dl-menuwrapper">
						<button class="dl-trigger">Open Menu</button>
						<ul class="dl-menu">
							<li>
								<a href="home.html">Home</a>
							</li>
							<li><a href="about.html">About</a></li>
						
							<li><a href="contact.html">Contact</a></li>
							<li><a href="prof.html">Profile</a></li>
							<li>
								<a href="#">Friends</a>
								<ul class="dl-submenu">
									<li><a href="friend.html">Find Friends</a></li>
									<li><a href="managefriend.html">Manage Friends</a></li>
								</ul>
							</li>
							
							<li><a onclick="logout()">Logout</a></li>
						</ul>

						</div><!-- /dl-menuwrapper -->
	</div>	
<div id="manage-friends" ><h3> Manage Friends </h3></div>
<!-- <button id="submit" onclick="dynamic()">Find Friends</button> -->
<div id="divtab0">
<h4> Waiting for friend's response </h4>
</div>

<div id="divtab1">
<h4> Waiting for your approval </h4>
</div>

<div id="divtab2">
<h4> Your Friends </h4>
</div>
 <script src="js/jquery.js"></script>
    <script src="js/bootstrap.min.js"></script>
	<script src="js/jquery.smooth-scroll.min.js"></script>
	<script src="js/jquery.dlmenu.js"></script>
	<script src="js/wow.min.js"></script>
	<script src="js/custom.js"></script>
</body>

</html>